<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <!-- _layout: post -->
    <!-- Begin Jekyll SEO tag v2.5.0 -->
    <title>Chisel 配置及入门 | iBug ①</title>
    <meta name="generator" content="Jekyll v3.8.5" />
    <meta property="og:title" content="Chisel 配置及入门" />
    <meta name="author" content="iBug" />
    <meta property="og:locale" content="zh_CN" />
    <meta name="description" content="The small personal site for iBug" />
    <meta property="og:description" content="The small personal site for iBug" />
    <link rel="canonical" href="https://ibugone.com/cn/chisel-101" />
    <meta property="og:url" content="https://ibugone.com/cn/chisel-101" />
    <meta property="og:site_name" content="iBug ①" />
    <script type="application/ld+json">
      {"description":"The small personal site for iBug","headline":"Chisel 配置及入门","@type":"WebPage","url":"https://ibugone.com/cn/chisel-101","author":{"@type":"Person","name":"iBug"},"@context":"http://schema.org"}
    </script>
    <!-- End Jekyll SEO tag -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#159A34">
    <!-- https://fonts.googleapis.com/css?family=Open+Sans:400,700 -->
    <link href='/assets/css/OpenSans.css' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=75e8eb4e631c0ced0474b5859dbff50dc5eef662">
    <link rel="shortcut icon" type="image/png" href="/assets/favicon.png">
    <time class="dt-published" datetime="" itemprop="datePublished">
      <script type="text/javascript" src="/assets/js/love.js" ></script>
    </head>
    <body>
      <nav>
        <div class="nav-bg"></div>
        <div class="nav-content hide-scrollbar">
          <div class="nav-left">
            <a href="/" class="nav-item home">iBug ①</a>
          </div>
          <div class="nav-right">
            <a href="/blog" class="nav-item">Blog</a>
            <a href="/project" class="nav-item">Projects</a>
          </div>
        </div>
      </nav>
      <section class="page-header">
        <h1 class="project-name">Chisel 配置及入门</h1>
        <h2 class="project-tagline">从配置到生成 Verilog</h2>
        <h3 class="project-date"><time datetime="" itemprop="datePublished"></time> &bull; iBug</h3>
      </section>
      <section class="main-content blog-post">
        <article>
          <p>Chisel (Constructing Hardware In a Scala Embedded Language) 是一种嵌入在高级编程语言 Scala 的硬件构建语言。Chisel 实际上只是一些特殊的类定义，预定义对象的集合，使用 Scala 的用法，所以在写 Chisel 程序时实际上是在写 Scala 程序。</p>
          <h2 id="1-系统需求">1. 系统需求</h2>
          <ul>
            <li>Java 运行环境</li>
            <li>Scala
              <ul>
                <li>SBT (Simple Build Tool)</li>
              </ul>
            </li>
          </ul>
          <h2 id="1a-windows-环境配置">1.A Windows 环境配置</h2>
          <h3 id="1a1-安装-java">1.A.1 安装 Java</h3>
          <p>Java 的安装并不困难，也不需要额外的操作。直接从 Oracle 官网下载一个合适的 JDK 安装包，运行安装即可。这里我选择的版本是 JDK 8 Update 191。</p>
          <ul>
            <li><a href="https://download.oracle.com/otn-pub/java/jdk/8u191-b12/2787e4a523244c269598db4e85c51e0c/jdk-8u191-windows-i586.exe">下载 JDK 8u191 Windows 32位</a></li>
            <li><a href="https://download.oracle.com/otn-pub/java/jdk/8u191-b12/2787e4a523244c269598db4e85c51e0c/jdk-8u191-windows-x64.exe">下载 JDK 8u191 Windows 64位</a></li>
          </ul>
          <p>安装过程直接点击 [下一步] 直到完成即可。</p>
          <h3 id="1a2-安装-scala-及-sbt">1.A.2 安装 Scala 及 SBT</h3>
          <p>Scala 是一门运行在 Java 上的语言，其编译器和工具链等都以 JAR 形式提供，因此不区分系统版本。SBT (Simple Build Tool) 是一个简单的 Scala 项目构建工具。Chisel 使用 SBT 来构建工程。对于 Windows 系统来说，只需要一个统一的安装包即可。编写本文时，SBT 的最新版本为 1.2.7，可以通过以下链接下载。</p>
          <ul>
            <li><a href="https://piccolo.link/sbt-1.2.7.msi">下载 SBT 1.2.7 Windows</a></li>
          </ul>
          <p>SBT 的安装也不复杂，双击 msi 安装包，一路点击 [下一步] 即可。</p>
          <p>虽然不是必要的，但是建议在安装完 SBT 之后重启一下电脑。</p>
          <h3 id="1a3-准备-chisel-依赖">1.A.3 准备 Chisel 依赖</h3>
          <p>安装好 SBT 之后，我们所有的准备工作都将借助 SBT 完成。</p>
          <p>首先解压附件 <code class="highlighter-rouge">chisel-101.tar.gz</code> 并打开文件夹 <code class="highlighter-rouge">chisel-101</code>，然后在该文件夹中打开命令提示符。Windows 7 下可以按住 Shift 键并在文件夹空白处点右键，此时的菜单中会有 “在此处打开命令提示符” 的选项，如图：</p>
          <p><img src="/image/chisel-intro/open-cmd.png" alt="Open Command Prompt here" /></p>
          <p>在打开的命令提示符中输入 <code class="highlighter-rouge">sbt run</code>，确保网络通畅，等待 SBT 工具下载所需的依赖。由于众所周知的原因，在国内下载很慢，并且有可能中断，需要耐心重试。如果一切顺利，SBT 会完成所需的全部依赖，然后编译样例代码并运行。参考截图如下：</p>
          <p><img src="/image/chisel-intro/sbt-first-run.png" alt="SBT Run" /></p>
          <h2 id="1b-linux-环境配置-ubuntu">1.B Linux 环境配置 (Ubuntu)</h2>
          <p>Ubuntu 资源丰富，配置起来十分简单。这里以 18.04 版本为例，配置过程全程使用终端命令。</p>
          <div class="language-shell highlighter-rouge">
            <div class="highlight">
              <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre>
            </td>
            <td class="rouge-code">
              <pre><span class="nb">echo</span> <span class="s2">"deb https://dl.bintray.com/sbt/debian /"</span> | <span class="nb">sudo </span>tee <span class="nt">-a</span> /etc/apt/sources.list.d/sbt.list
<span class="nb">sudo </span>apt-key adv <span class="nt">--keyserver</span> hkp://keyserver.ubuntu.com:80 <span class="nt">--recv</span> 2EE0EA64E40A89B84B2DF73499E82A75642AC823
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get install default-jdk build-essential perl sbt
</pre>
            </td>
          </tr>
        </tbody>
      </table>
    </code></pre>
</div>
</div>
<p>参考链接：<a href="https://www.scala-sbt.org/1.0/docs/Installing-sbt-on-Linux.html">Installing sbt on Linux</a></p>
<p>以上操作会添加 SBT 提供的 APT 源，然后刷新 APT 软件包列表，并安装 JDK, SBT 等需要的软件包。</p>
<p>接下来解包附件 <code class="highlighter-rouge">chisel-101.tar.gz</code> （见末尾），并利用 sbt 配置所需的依赖。这些依赖全部是 Java 软件包，因此过程十分简单。请确保网络畅通，由于众所周知的原因，在国内下载很慢，并且有可能中断，需要耐心重试。</p>
<div class="language-shell highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="nb">tar </span>zxvf chisel-101.tar.gz
<span class="nb">cd </span>chisel-101/
sbt run
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>如果一切顺利，SBT 会完成所需的全部依赖，然后编译样例代码 <code class="highlighter-rouge">hello.scala</code> 并运行。具体输出可以参考上面 Windows 7 系统中的截图。</p>
<h2 id="2-开始第一个-chisel-工程并生成-verilog-代码">2. 开始第一个 Chisel 工程并生成 Verilog 代码</h2>
<p>保留好附件 <code class="highlighter-rouge">chisel-101.tar.gz</code> 或者解包出来的文件夹 <code class="highlighter-rouge">chisel-101</code>，后面我们会经常用到它。</p>
<p>请注意，本文不是教你如何编辑 Scala 或 Chisel 代码，而是关注 Verilog 的生成。由于未直接使用<a href="https://github.com/ucb-bar/chisel-tutorial">官方的教程仓库</a>，因此避开了 Verilator 的依赖（它相当不好配置）。</p>
<h3 id="21-第一个组合逻辑电路">2.1 第一个组合逻辑电路</h3>
<p>用文本编辑器或者 IDE (例如 IntelliJ IDEA) 打开 <code class="highlighter-rouge">src/main/scala/example/hello.scala</code>，观察内容：</p>
<div class="language-scala highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="k">package</span> <span class="nn">example</span>

<span class="k">object</span> <span class="nc">Hello</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">println</span><span class="o">(</span><span class="s">"Hello, Chisel!"</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>这是一个最简单的 Scala 程序，它只输出一行 <code class="highlighter-rouge">Hello, Chisel!</code>。这并不是我们要学习的 Chisel 代码，所以现在把这个文件删掉。</p>
<p>下面我们用一个简单的示例（组合逻辑电路）来展示 Chisel，以及生成 Verilog 文件。</p>
<div class="language-scala highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="k">package</span> <span class="nn">example</span>

<span class="k">import</span> <span class="nn">chisel3._</span>

<span class="k">class</span> <span class="nc">FullAdder</span> <span class="k">extends</span> <span class="nc">Module</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">a</span>    <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">b</span>    <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">cin</span>  <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">sum</span>  <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">cout</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
  <span class="o">})</span>

  <span class="c1">// Generate the sum
</span>  <span class="k">val</span> <span class="n">a_xor_b</span> <span class="k">=</span> <span class="n">io</span><span class="o">.</span><span class="n">a</span> <span class="o">^</span> <span class="n">io</span><span class="o">.</span><span class="n">b</span>
  <span class="n">io</span><span class="o">.</span><span class="n">sum</span> <span class="o">:=</span> <span class="n">a_xor_b</span> <span class="o">^</span> <span class="n">io</span><span class="o">.</span><span class="n">cin</span>
  <span class="c1">// Generate the carry
</span>  <span class="k">val</span> <span class="n">a_and_b</span> <span class="k">=</span> <span class="n">io</span><span class="o">.</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">io</span><span class="o">.</span><span class="n">b</span>
  <span class="k">val</span> <span class="n">b_and_cin</span> <span class="k">=</span> <span class="n">io</span><span class="o">.</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">io</span><span class="o">.</span><span class="n">cin</span>
  <span class="k">val</span> <span class="n">a_and_cin</span> <span class="k">=</span> <span class="n">io</span><span class="o">.</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">io</span><span class="o">.</span><span class="n">cin</span>
  <span class="n">io</span><span class="o">.</span><span class="n">cout</span> <span class="o">:=</span> <span class="n">a_and_b</span> <span class="o">|</span> <span class="n">b_and_cin</span> <span class="o">|</span> <span class="n">a_and_cin</span>
<span class="o">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>这就是一个 1 位全加器模块。把它放在 <code class="highlighter-rouge">src/main/scala/example/Main.scala</code> 里，然后我们来尝试编译（综合）：</p>
<p>还是在工程目录 (有 <code class="highlighter-rouge">build.sbt</code> 文件的那个地方) 打开命令提示符（或终端），输入 <code class="highlighter-rouge">sbt run</code> 开始编译。稍等片刻，就会发现编译失败了。最后几行的错误信息中可以看到这样的内容：</p>
<div class="language-shell highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="o">[</span>error] java.lang.RuntimeException: No main class detected.
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>我们的样例代码只包含了电路模块，并没有一个 “主函数” 可以让 Scala 运行。</p>
<p>打开刚才的 <code class="highlighter-rouge">Main.scala</code> 文件，在文件后面追加这几行代码：</p>
<div class="language-scala highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="k">object</span> <span class="nc">ChiselExample</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="n">chisel3</span><span class="o">.</span><span class="nc">Driver</span><span class="o">.</span><span class="n">execute</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">FullAdder</span><span class="o">)</span>
<span class="o">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>再次在工程目录中运行 <code class="highlighter-rouge">sbt run</code>，观察输出，这时候整个项目应该能正常编译了。</p>
<p>也许细心的你已经发现目录中出现了 <code class="highlighter-rouge">FullAdder.v</code> 这样一个文件。没错，这就是生成的 Verilog 代码！赶紧打开看看：</p>
<div class="language-verilog highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="k">module</span> <span class="n">FullAdder</span><span class="p">(</span> <span class="c1">// @[:@3.2]
</span>  <span class="kt">input</span>   <span class="n">clock</span><span class="o">,</span> <span class="c1">// @[:@4.4]
</span>  <span class="kt">input</span>   <span class="n">reset</span><span class="o">,</span> <span class="c1">// @[:@5.4]
</span>  <span class="kt">input</span>   <span class="n">io_a</span><span class="o">,</span> <span class="c1">// @[:@6.4]
</span>  <span class="kt">input</span>   <span class="n">io_b</span><span class="o">,</span> <span class="c1">// @[:@6.4]
</span>  <span class="kt">input</span>   <span class="n">io_cin</span><span class="o">,</span> <span class="c1">// @[:@6.4]
</span>  <span class="kt">output</span>  <span class="n">io_sum</span><span class="o">,</span> <span class="c1">// @[:@6.4]
</span>  <span class="kt">output</span>  <span class="n">io_cout</span> <span class="c1">// @[:@6.4]
</span><span class="p">)</span><span class="o">;</span>
  <span class="kt">wire</span>  <span class="n">a_xor_b</span><span class="o">;</span> <span class="c1">// @[Main.scala 15:22:@8.4]
</span>  <span class="kt">wire</span>  <span class="n">a_and_b</span><span class="o">;</span> <span class="c1">// @[Main.scala 18:22:@11.4]
</span>  <span class="kt">wire</span>  <span class="n">b_and_cin</span><span class="o">;</span> <span class="c1">// @[Main.scala 19:24:@12.4]
</span>  <span class="kt">wire</span>  <span class="n">a_and_cin</span><span class="o">;</span> <span class="c1">// @[Main.scala 20:24:@13.4]
</span>  <span class="kt">wire</span>  <span class="mi">_</span><span class="n">T_16</span><span class="o">;</span> <span class="c1">// @[Main.scala 21:22:@14.4]
</span>  <span class="k">assign</span> <span class="n">a_xor_b</span> <span class="o">=</span> <span class="n">io_a</span> <span class="o">^</span> <span class="n">io_b</span><span class="o">;</span> <span class="c1">// @[Main.scala 15:22:@8.4]
</span>  <span class="k">assign</span> <span class="n">a_and_b</span> <span class="o">=</span> <span class="n">io_a</span> <span class="o">&amp;</span> <span class="n">io_b</span><span class="o">;</span> <span class="c1">// @[Main.scala 18:22:@11.4]
</span>  <span class="k">assign</span> <span class="n">b_and_cin</span> <span class="o">=</span> <span class="n">io_b</span> <span class="o">&amp;</span> <span class="n">io_cin</span><span class="o">;</span> <span class="c1">// @[Main.scala 19:24:@12.4]
</span>  <span class="k">assign</span> <span class="n">a_and_cin</span> <span class="o">=</span> <span class="n">io_a</span> <span class="o">&amp;</span> <span class="n">io_cin</span><span class="o">;</span> <span class="c1">// @[Main.scala 20:24:@13.4]
</span>  <span class="k">assign</span> <span class="mi">_</span><span class="n">T_16</span> <span class="o">=</span> <span class="n">a_and_b</span> <span class="o">|</span> <span class="n">b_and_cin</span><span class="o">;</span> <span class="c1">// @[Main.scala 21:22:@14.4]
</span>  <span class="k">assign</span> <span class="n">io_sum</span> <span class="o">=</span> <span class="n">a_xor_b</span> <span class="o">^</span> <span class="n">io_cin</span><span class="o">;</span> <span class="c1">// @[Main.scala 16:10:@10.4]
</span>  <span class="k">assign</span> <span class="n">io_cout</span> <span class="o">=</span> <span class="mi">_</span><span class="n">T_16</span> <span class="o">|</span> <span class="n">a_and_cin</span><span class="o">;</span> <span class="c1">// @[Main.scala 21:11:@16.4]
</span><span class="k">endmodule</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>虽然看起来十分机械化，但是生成的这个 Verilog 代码是可以放在其他软件 (如 Xilinx Vidado) 中综合的。</p>
<p>好了，我们的第一个样例就到这里，你已经知道怎么写 Chisel 代码并生成 Verilog 了。</p>
<h3 id="22-第一个时序逻辑电路">2.2 第一个时序逻辑电路</h3>
<p>我从网上的样例中选出了这个作为时序逻辑电路的示范</p>
<div class="language-scala highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="k">package</span> <span class="nn">example</span>

<span class="k">import</span> <span class="nn">chisel3._</span>

<span class="k">class</span> <span class="nc">EnableShiftRegister</span> <span class="k">extends</span> <span class="nc">Module</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">in</span>    <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">shift</span> <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">Bool</span><span class="o">())</span>
    <span class="k">val</span> <span class="n">out</span>   <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">))</span>
  <span class="o">})</span>
  <span class="k">val</span> <span class="n">r0</span> <span class="k">=</span> <span class="nc">Reg</span><span class="o">(</span><span class="nc">UInt</span><span class="o">())</span>
  <span class="k">val</span> <span class="n">r1</span> <span class="k">=</span> <span class="nc">Reg</span><span class="o">(</span><span class="nc">UInt</span><span class="o">())</span>
  <span class="k">val</span> <span class="n">r2</span> <span class="k">=</span> <span class="nc">Reg</span><span class="o">(</span><span class="nc">UInt</span><span class="o">())</span>
  <span class="k">val</span> <span class="n">r3</span> <span class="k">=</span> <span class="nc">Reg</span><span class="o">(</span><span class="nc">UInt</span><span class="o">())</span>
  <span class="n">when</span><span class="o">(</span><span class="n">reset</span><span class="o">.</span><span class="n">toBool</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">r0</span> <span class="o">:=</span> <span class="mf">0.</span><span class="n">U</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">)</span>
    <span class="n">r1</span> <span class="o">:=</span> <span class="mf">0.</span><span class="n">U</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">)</span>
    <span class="n">r2</span> <span class="o">:=</span> <span class="mf">0.</span><span class="n">U</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">)</span>
    <span class="n">r3</span> <span class="o">:=</span> <span class="mf">0.</span><span class="n">U</span><span class="o">(</span><span class="mf">4.</span><span class="n">W</span><span class="o">)</span>
  <span class="o">}</span> <span class="o">.</span><span class="n">elsewhen</span><span class="o">(</span><span class="n">io</span><span class="o">.</span><span class="n">shift</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">r0</span> <span class="o">:=</span> <span class="n">io</span><span class="o">.</span><span class="n">in</span>
    <span class="n">r1</span> <span class="o">:=</span> <span class="n">r0</span>
    <span class="n">r2</span> <span class="o">:=</span> <span class="n">r1</span>
    <span class="n">r3</span> <span class="o">:=</span> <span class="n">r2</span>
  <span class="o">}</span>
  <span class="n">io</span><span class="o">.</span><span class="n">out</span> <span class="o">:=</span> <span class="n">r3</span>
<span class="o">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>上一节中编写的 <code class="highlighter-rouge">Main.scala</code> 先放着别动，把上面的代码保存到另一个文件，例如 <code class="highlighter-rouge">src/main/scala/example/Sequential.scala</code> 中，我们来尝试编译：在命令提示符或者终端中运行 <code class="highlighter-rouge">sbt run</code>。当 SBT 运行完成之后，你肯定迫不及待地想看看 <code class="highlighter-rouge">EnableShiftRegister.v</code> 长什么样。不过这次你可能要失望了，因为这个文件并不存在。</p>
<p>怎么回事呢？</p>
<p>打开上一节的 <code class="highlighter-rouge">Main.scala</code>，观察内容：</p>
<div class="language-scala highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="k">object</span> <span class="nc">ChiselExample</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="n">chisel3</span><span class="o">.</span><span class="nc">Driver</span><span class="o">.</span><span class="n">execute</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">FullAdder</span><span class="o">)</span>
<span class="o">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>也许你已经发现了，是这个地方决定哪些模块要被编译。所以我们添加一行，让它也编译新的模块。现在代码看起来像这样：</p>
<div class="language-scala highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="k">object</span> <span class="nc">ChiselExample</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="n">chisel3</span><span class="o">.</span><span class="nc">Driver</span><span class="o">.</span><span class="n">execute</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">FullAdder</span><span class="o">)</span>
  <span class="n">chisel3</span><span class="o">.</span><span class="nc">Driver</span><span class="o">.</span><span class="n">execute</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">EnableShiftRegister</span><span class="o">)</span>
<span class="o">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>好了，再次运行 <code class="highlighter-rouge">sbt run</code>，你就可以看到 <code class="highlighter-rouge">EnableShiftRegister.v</code> 了，它的内容应该是这样：</p>
<div class="language-verilog highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="k">module</span> <span class="n">EnableShiftRegister</span><span class="p">(</span> <span class="c1">// @[:@3.2]
</span>  <span class="kt">input</span>        <span class="n">clock</span><span class="o">,</span> <span class="c1">// @[:@4.4]
</span>  <span class="kt">input</span>        <span class="n">reset</span><span class="o">,</span> <span class="c1">// @[:@5.4]
</span>  <span class="kt">input</span>  <span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">io_in</span><span class="o">,</span> <span class="c1">// @[:@6.4]
</span>  <span class="kt">input</span>        <span class="n">io_shift</span><span class="o">,</span> <span class="c1">// @[:@6.4]
</span>  <span class="kt">output</span> <span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">io_out</span> <span class="c1">// @[:@6.4]
</span><span class="p">)</span><span class="o">;</span>
  <span class="kt">reg</span> <span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">r0</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 11:15:@8.4]
</span>  <span class="kt">reg</span> <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="mi">_</span><span class="n">RAND_0</span><span class="o">;</span>
  <span class="kt">reg</span> <span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">r1</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 12:15:@9.4]
</span>  <span class="kt">reg</span> <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="mi">_</span><span class="n">RAND_1</span><span class="o">;</span>
  <span class="kt">reg</span> <span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">r2</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 13:15:@10.4]
</span>  <span class="kt">reg</span> <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="mi">_</span><span class="n">RAND_2</span><span class="o">;</span>
  <span class="kt">reg</span> <span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">r3</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 14:15:@11.4]
</span>  <span class="kt">reg</span> <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="mi">_</span><span class="n">RAND_3</span><span class="o">;</span>
  <span class="kt">wire</span> <span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="mi">_</span><span class="n">GEN_0</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 20:25:@20.6]
</span>  <span class="kt">wire</span> <span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="mi">_</span><span class="n">GEN_1</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 20:25:@20.6]
</span>  <span class="kt">wire</span> <span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="mi">_</span><span class="n">GEN_2</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 20:25:@20.6]
</span>  <span class="kt">wire</span> <span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="mi">_</span><span class="n">GEN_3</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 20:25:@20.6]
</span>  <span class="k">assign</span> <span class="mi">_</span><span class="n">GEN_0</span> <span class="o">=</span> <span class="n">io_shift</span> <span class="o">?</span> <span class="n">io_in</span> <span class="o">:</span> <span class="n">r0</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 20:25:@20.6]
</span>  <span class="k">assign</span> <span class="mi">_</span><span class="n">GEN_1</span> <span class="o">=</span> <span class="n">io_shift</span> <span class="o">?</span> <span class="n">r0</span> <span class="o">:</span> <span class="n">r1</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 20:25:@20.6]
</span>  <span class="k">assign</span> <span class="mi">_</span><span class="n">GEN_2</span> <span class="o">=</span> <span class="n">io_shift</span> <span class="o">?</span> <span class="n">r1</span> <span class="o">:</span> <span class="n">r2</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 20:25:@20.6]
</span>  <span class="k">assign</span> <span class="mi">_</span><span class="n">GEN_3</span> <span class="o">=</span> <span class="n">io_shift</span> <span class="o">?</span> <span class="n">r2</span> <span class="o">:</span> <span class="n">r3</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 20:25:@20.6]
</span>  <span class="k">assign</span> <span class="n">io_out</span> <span class="o">=</span> <span class="n">r3</span><span class="o">;</span> <span class="c1">// @[Sequential.scala 26:10:@26.4]
</span><span class="cp">`ifdef</span> <span class="n">RANDOMIZE_GARBAGE_ASSIGN</span>
<span class="cp">`define</span> RANDOMIZE<span class="cp">
`endif</span>
<span class="cp">`ifdef</span> <span class="n">RANDOMIZE_INVALID_ASSIGN</span>
<span class="cp">`define</span> RANDOMIZE<span class="cp">
`endif</span>
<span class="cp">`ifdef</span> <span class="n">RANDOMIZE_REG_INIT</span>
<span class="cp">`define</span> RANDOMIZE<span class="cp">
`endif</span>
<span class="cp">`ifdef</span> <span class="n">RANDOMIZE_MEM_INIT</span>
<span class="cp">`define</span> RANDOMIZE<span class="cp">
`endif</span>
<span class="cp">`ifndef</span> <span class="n">RANDOM</span>
<span class="cp">`define</span> RANDOM <span class="err">$</span>random<span class="cp">
`endif</span>
<span class="cp">`ifdef</span> <span class="n">RANDOMIZE</span>
  <span class="kt">integer</span> <span class="n">initvar</span><span class="o">;</span>
  <span class="k">initial</span> <span class="k">begin</span>
    <span class="cp">`ifdef</span> <span class="n">INIT_RANDOM</span>
      <span class="cp">`INIT_RANDOM</span>
    <span class="cp">`endif</span>
    <span class="cp">`ifndef</span> <span class="n">VERILATOR</span>
      <span class="p">#</span><span class="mf">0.002</span> <span class="k">begin</span> <span class="k">end</span>
    <span class="cp">`endif</span>
  <span class="cp">`ifdef</span> <span class="n">RANDOMIZE_REG_INIT</span>
  <span class="mi">_</span><span class="n">RAND_0</span> <span class="o">=</span> <span class="o">{</span><span class="mi">1</span><span class="o">{</span><span class="cp">`RANDOM</span><span class="o">}};</span>
  <span class="n">r0</span> <span class="o">=</span> <span class="mi">_</span><span class="n">RAND_0</span><span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="o">;</span>
  <span class="cp">`endif</span> <span class="c1">// RANDOMIZE_REG_INIT
</span>  <span class="cp">`ifdef</span> <span class="n">RANDOMIZE_REG_INIT</span>
  <span class="mi">_</span><span class="n">RAND_1</span> <span class="o">=</span> <span class="o">{</span><span class="mi">1</span><span class="o">{</span><span class="cp">`RANDOM</span><span class="o">}};</span>
  <span class="n">r1</span> <span class="o">=</span> <span class="mi">_</span><span class="n">RAND_1</span><span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="o">;</span>
  <span class="cp">`endif</span> <span class="c1">// RANDOMIZE_REG_INIT
</span>  <span class="cp">`ifdef</span> <span class="n">RANDOMIZE_REG_INIT</span>
  <span class="mi">_</span><span class="n">RAND_2</span> <span class="o">=</span> <span class="o">{</span><span class="mi">1</span><span class="o">{</span><span class="cp">`RANDOM</span><span class="o">}};</span>
  <span class="n">r2</span> <span class="o">=</span> <span class="mi">_</span><span class="n">RAND_2</span><span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="o">;</span>
  <span class="cp">`endif</span> <span class="c1">// RANDOMIZE_REG_INIT
</span>  <span class="cp">`ifdef</span> <span class="n">RANDOMIZE_REG_INIT</span>
  <span class="mi">_</span><span class="n">RAND_3</span> <span class="o">=</span> <span class="o">{</span><span class="mi">1</span><span class="o">{</span><span class="cp">`RANDOM</span><span class="o">}};</span>
  <span class="n">r3</span> <span class="o">=</span> <span class="mi">_</span><span class="n">RAND_3</span><span class="p">[</span><span class="mi">3</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="o">;</span>
  <span class="cp">`endif</span> <span class="c1">// RANDOMIZE_REG_INIT
</span>  <span class="k">end</span>
<span class="cp">`endif</span> <span class="c1">// RANDOMIZE
</span>  <span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">clock</span><span class="p">)</span> <span class="k">begin</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="k">begin</span>
      <span class="n">r0</span> <span class="o">&lt;=</span> <span class="mh">4'h0</span><span class="o">;</span>
    <span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
      <span class="n">r0</span> <span class="o">&lt;=</span> <span class="mi">_</span><span class="n">GEN_0</span><span class="o">;</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="k">begin</span>
      <span class="n">r1</span> <span class="o">&lt;=</span> <span class="mh">4'h0</span><span class="o">;</span>
    <span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
      <span class="n">r1</span> <span class="o">&lt;=</span> <span class="mi">_</span><span class="n">GEN_1</span><span class="o">;</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="k">begin</span>
      <span class="n">r2</span> <span class="o">&lt;=</span> <span class="mh">4'h0</span><span class="o">;</span>
    <span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
      <span class="n">r2</span> <span class="o">&lt;=</span> <span class="mi">_</span><span class="n">GEN_2</span><span class="o">;</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="k">begin</span>
      <span class="n">r3</span> <span class="o">&lt;=</span> <span class="mh">4'h0</span><span class="o">;</span>
    <span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
      <span class="n">r3</span> <span class="o">&lt;=</span> <span class="mi">_</span><span class="n">GEN_3</span><span class="o">;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">endmodule</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>注意到，由于 Chisel 语言只有 0/1，不支持三态或者高阻态，所以这里对几个寄存器采取了随机初始化的办法。另外也可以看到，尽管模块中没有声明时钟 <code class="highlighter-rouge">clock</code> 和重置 <code class="highlighter-rouge">reset</code> 信号，但是所有编译出来的 Verilog 代码都会包含这两个输入，并且在有需要的时候向嵌套的模块传递，这可以在下面这个示例中观察到。</p>
<h3 id="23-嵌套模块">2.3 嵌套模块</h3>
<p>这次我们使用前面编写的 1 位全加器来构建一个多位全加器</p>
<div class="language-scala highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="k">package</span> <span class="nn">example</span>

<span class="k">import</span> <span class="nn">chisel3._</span>

<span class="k">class</span> <span class="nc">Inner</span> <span class="k">extends</span> <span class="nc">Module</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">dataIn</span>  <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">dataOut</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
  <span class="o">})</span>
  <span class="k">val</span> <span class="n">data</span> <span class="k">=</span> <span class="nc">RegNext</span><span class="o">(</span><span class="n">io</span><span class="o">.</span><span class="n">dataIn</span><span class="o">)</span>
  <span class="n">io</span><span class="o">.</span><span class="n">dataOut</span> <span class="o">:=</span> <span class="n">data</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Outer</span> <span class="k">extends</span> <span class="nc">Module</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">Bundle</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">dataIn</span>  <span class="k">=</span> <span class="nc">Input</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
    <span class="k">val</span> <span class="n">dataOut</span> <span class="k">=</span> <span class="nc">Output</span><span class="o">(</span><span class="nc">UInt</span><span class="o">(</span><span class="mf">1.</span><span class="n">W</span><span class="o">))</span>
  <span class="o">})</span>
  <span class="k">val</span> <span class="n">core</span> <span class="k">=</span> <span class="nc">Module</span><span class="o">(</span><span class="k">new</span> <span class="nc">Inner</span><span class="o">()).</span><span class="n">io</span>
  <span class="n">core</span><span class="o">.</span><span class="n">dataIn</span> <span class="o">:=</span> <span class="n">io</span><span class="o">.</span><span class="n">dataIn</span>
  <span class="n">io</span><span class="o">.</span><span class="n">dataOut</span> <span class="o">:=</span> <span class="n">core</span><span class="o">.</span><span class="n">dataOut</span>
<span class="o">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>把以上内容保存为 <code class="highlighter-rouge">src/main/scala/example/Nested.scala</code>。同样，我们要修改 <code class="highlighter-rouge">Main.scala</code>，使它编译新的 <code class="highlighter-rouge">Outer</code> 模块。</p>
<div class="language-scala highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="k">object</span> <span class="nc">ChiselExample</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="n">chisel3</span><span class="o">.</span><span class="nc">Driver</span><span class="o">.</span><span class="n">execute</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">Outer</span><span class="o">)</span>
<span class="o">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>运行 <code class="highlighter-rouge">sbt run</code>，然后观察生成的 <code class="highlighter-rouge">Outer.v</code>。可以发现，Chisel 自动将 <code class="highlighter-rouge">clock</code> 从模块 <code class="highlighter-rouge">Outer</code> 传递到了模块 <code class="highlighter-rouge">Inner</code>。</p>
<div class="language-verilog highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="k">module</span> <span class="n">Inner</span><span class="p">(</span> <span class="c1">// @[:@3.2]
</span>  <span class="kt">input</span>   <span class="n">clock</span><span class="o">,</span> <span class="c1">// @[:@4.4]
</span>  <span class="kt">input</span>   <span class="n">io_dataIn</span><span class="o">,</span> <span class="c1">// @[:@6.4]
</span>  <span class="kt">output</span>  <span class="n">io_dataOut</span> <span class="c1">// @[:@6.4]
</span><span class="p">)</span><span class="o">;</span>
  <span class="kt">reg</span>  <span class="n">data</span><span class="o">;</span> <span class="c1">// @[Nested.scala 10:21:@8.4]
</span>  <span class="kt">reg</span> <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="mi">_</span><span class="n">RAND_0</span><span class="o">;</span>
  <span class="k">assign</span> <span class="n">io_dataOut</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span> <span class="c1">// @[Nested.scala 11:14:@10.4]
</span><span class="cp">`ifdef</span> <span class="n">RANDOMIZE_GARBAGE_ASSIGN</span>
<span class="cp">`define</span> RANDOMIZE<span class="cp">
`endif</span>
<span class="cp">`ifdef</span> <span class="n">RANDOMIZE_INVALID_ASSIGN</span>
<span class="cp">`define</span> RANDOMIZE<span class="cp">
`endif</span>
<span class="cp">`ifdef</span> <span class="n">RANDOMIZE_REG_INIT</span>
<span class="cp">`define</span> RANDOMIZE<span class="cp">
`endif</span>
<span class="cp">`ifdef</span> <span class="n">RANDOMIZE_MEM_INIT</span>
<span class="cp">`define</span> RANDOMIZE<span class="cp">
`endif</span>
<span class="cp">`ifndef</span> <span class="n">RANDOM</span>
<span class="cp">`define</span> RANDOM <span class="err">$</span>random<span class="cp">
`endif</span>
<span class="cp">`ifdef</span> <span class="n">RANDOMIZE</span>
  <span class="kt">integer</span> <span class="n">initvar</span><span class="o">;</span>
  <span class="k">initial</span> <span class="k">begin</span>
    <span class="cp">`ifdef</span> <span class="n">INIT_RANDOM</span>
      <span class="cp">`INIT_RANDOM</span>
    <span class="cp">`endif</span>
    <span class="cp">`ifndef</span> <span class="n">VERILATOR</span>
      <span class="p">#</span><span class="mf">0.002</span> <span class="k">begin</span> <span class="k">end</span>
    <span class="cp">`endif</span>
  <span class="cp">`ifdef</span> <span class="n">RANDOMIZE_REG_INIT</span>
  <span class="mi">_</span><span class="n">RAND_0</span> <span class="o">=</span> <span class="o">{</span><span class="mi">1</span><span class="o">{</span><span class="cp">`RANDOM</span><span class="o">}};</span>
  <span class="n">data</span> <span class="o">=</span> <span class="mi">_</span><span class="n">RAND_0</span><span class="p">[</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="o">;</span>
  <span class="cp">`endif</span> <span class="c1">// RANDOMIZE_REG_INIT
</span>  <span class="k">end</span>
<span class="cp">`endif</span> <span class="c1">// RANDOMIZE
</span>  <span class="k">always</span> <span class="o">@</span><span class="p">(</span><span class="kt">posedge</span> <span class="n">clock</span><span class="p">)</span> <span class="k">begin</span>
    <span class="n">data</span> <span class="o">&lt;=</span> <span class="n">io_dataIn</span><span class="o">;</span>
  <span class="k">end</span>
<span class="k">endmodule</span>
<span class="k">module</span> <span class="n">Outer</span><span class="p">(</span> <span class="c1">// @[:@12.2]
</span>  <span class="kt">input</span>   <span class="n">clock</span><span class="o">,</span> <span class="c1">// @[:@13.4]
</span>  <span class="kt">input</span>   <span class="n">reset</span><span class="o">,</span> <span class="c1">// @[:@14.4]
</span>  <span class="kt">input</span>   <span class="n">io_dataIn</span><span class="o">,</span> <span class="c1">// @[:@15.4]
</span>  <span class="kt">output</span>  <span class="n">io_dataOut</span> <span class="c1">// @[:@15.4]
</span><span class="p">)</span><span class="o">;</span>
  <span class="kt">wire</span>  <span class="n">Inner_clock</span><span class="o">;</span> <span class="c1">// @[Nested.scala 19:20:@17.4]
</span>  <span class="kt">wire</span>  <span class="n">Inner_io_dataIn</span><span class="o">;</span> <span class="c1">// @[Nested.scala 19:20:@17.4]
</span>  <span class="kt">wire</span>  <span class="n">Inner_io_dataOut</span><span class="o">;</span> <span class="c1">// @[Nested.scala 19:20:@17.4]
</span>  <span class="n">Inner</span> <span class="n">Inner</span> <span class="p">(</span> <span class="c1">// @[Nested.scala 19:20:@17.4]
</span>    <span class="o">.</span><span class="n">clock</span><span class="p">(</span><span class="n">Inner_clock</span><span class="p">)</span><span class="o">,</span>
    <span class="o">.</span><span class="n">io_dataIn</span><span class="p">(</span><span class="n">Inner_io_dataIn</span><span class="p">)</span><span class="o">,</span>
    <span class="o">.</span><span class="n">io_dataOut</span><span class="p">(</span><span class="n">Inner_io_dataOut</span><span class="p">)</span>
  <span class="p">)</span><span class="o">;</span>
  <span class="k">assign</span> <span class="n">io_dataOut</span> <span class="o">=</span> <span class="n">Inner_io_dataOut</span><span class="o">;</span> <span class="c1">// @[Nested.scala 21:14:@21.4]
</span>  <span class="k">assign</span> <span class="n">Inner_clock</span> <span class="o">=</span> <span class="n">clock</span><span class="o">;</span> <span class="c1">// @[:@18.4]
</span>  <span class="k">assign</span> <span class="n">Inner_io_dataIn</span> <span class="o">=</span> <span class="n">io_dataIn</span><span class="o">;</span> <span class="c1">// @[Nested.scala 20:15:@20.4]
</span><span class="k">endmodule</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<h3 id="24-关于多个主函数-scala-入口">2.4 关于多个主函数 (Scala 入口)</h3>
<p>有时候你并不需要一次编译全部代码，而反复修改 <code class="highlighter-rouge">Main.scala</code> 中的那个 <code class="highlighter-rouge">object</code> 又较为麻烦，那有什么办法简化这种工作吗？就像 Make 可以指定目一样。</p>
<p>方法是，编写多个 “主函数”，然后按需选择入口。例如</p>
<div class="language-scala highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre>
  </td>
  <td class="rouge-code">
    <pre><span class="k">object</span> <span class="nc">Main</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="n">chisel3</span><span class="o">.</span><span class="nc">Driver</span><span class="o">.</span><span class="n">execute</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">FullAdder</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Sequential</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="n">chisel3</span><span class="o">.</span><span class="nc">Driver</span><span class="o">.</span><span class="n">execute</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">EnableShiftRegister</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Nested</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="n">chisel3</span><span class="o">.</span><span class="nc">Driver</span><span class="o">.</span><span class="n">execute</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="o">()</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">Outer</span><span class="o">)</span>
<span class="o">}</span>
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>请注意，这时候由于我们有三个入口，因此直接运行 <code class="highlighter-rouge">sbt run</code> 的时候将无法编译。我们需要指定一个入口：</p>
<div class="language-shell highlighter-rouge">
  <div class="highlight">
    <pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre>
  </td>
  <td class="rouge-code">
    <pre>sbt run Sequential
</pre>
  </td>
</tr>
</tbody>
</table>
</code></pre>
</div>
</div>
<p>运行上面的命令后，可以看到模块 <code class="highlighter-rouge">EnableShiftRegister</code> 被编译，生成了 <code class="highlighter-rouge">EnableShiftRegister.v</code>，而其他模块并没有生成对应的 Verilog 文件。</p>
<p>好了，关于生成 Verilog 代码就到这里了。</p>
<hr />
<p>更多样例代码可以在 GitHub 仓库 <a href="https://github.com/ucb-bar/chisel-tutorial">chisel-tutorial</a> 中找到。</p>
<h1 id="附录">附录</h1>
<ul>
  <li>附件 <code class="highlighter-rouge">chisel-101.tar.gz</code> 下载： <a href="https://github.com/iBug/Archive/releases/download/Release/chisel-101.tar.gz">https://github.com/iBug/Archive/releases/download/Release/chisel-101.tar.gz</a></li>
  <li>
    <p>包含三个样例代码的 <code class="highlighter-rouge">chisel-101-with-examples.tar.gz</code> 下载： <a href="https://github.com/iBug/Archive/releases/download/Release/chisel-101-with-examples.tar.gz">https://github.com/iBug/Archive/releases/download/Release/chisel-101-with-examples.tar.gz</a></p>
  </li>
  <li>Chisel 官方网站： <a href="https://chisel.eecs.berkeley.edu/">https://chisel.eecs.berkeley.edu/</a></li>
  <li>GitHub 教程仓库： <a href="https://github.com/freechipsproject/chisel3/">https://github.com/freechipsproject/chisel3/</a></li>
</ul>
</article>
<span class="post-tags">
  <b>Tags: </b>
  <a href="/tags/study-notes" class="tag">study-notes</a>
</span>
<footer class="site-footer">
  <span class="site-footer-credits">
    <div>
      <span style="float:left;padding-left:10px;height:0px;">
        &laquo; Previous
      </span>
      <span style="float:right;padding-right:10px;height:0px;">
        Next &raquo;
      </span>
    </div>
    <div align="center">
      <p><a href="/blog"><b>Return to index</b></a></p>
      <p>Link to this article: <a href="/cn/chisel-101">/cn/chisel-101</a></p>
      <p><small>Content licensed under the <a href="https://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 license</a>. Attribution required.</small></p>
    </div>
  </span>
</footer>
</section>
<script type="text/javascript" src="/assets/js/line.js" ></script>
<script type="text/javascript">
  var navbar = document.getElementById("navbar");
  var sticky = navbar.offsetTop;
  window.onscroll = function() {
  	if (window.pageYOffset >= sticky) {
  		navbar.classList.add("sticky")
  	} else {
  		navbar.classList.remove("sticky");
  	}
  }
</script>
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-115907213-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>